# LiuProxy Nexus v4.0 - Unified Development Roadmap

**最后更新**: [2025-10-14]

本文档是 `liuproxy_nexus` 项目的“活文档”，它既是未来的开发计划，也是对已完成工作的进度跟踪。它详细记录了每个阶段的核心任务、关键决策和重要产出。

---
## **总览**

*   **阶段一 ~ 阶段六**: `liuproxy_gateway v3.0` 的所有历史迭代均已完成。
*   **阶段七: 移动端架构升级与 VLESS 支持 (已完成)**
*   **阶段八: 代理池与动态资源管理 (已完成)** - 当前阶段，旨在集成动态的、自维护的公共代理资源。
*   **阶段九: DNS 增强与高级路由 (计划中)**
*   **阶段十: 架构演进与生态系统 (未来规划)**
* 
---
## **详细路线图**

### **阶段一 ~ 阶段六 (Completed)**
*   `liuproxy_gateway v3.0` 的所有迭代均已完成，构成了 `nexus v4.0` 的坚实基础。

---

### **阶段七：移动端架构升级与 VLESS 支持 (Completed)**

本阶段的核心目标是将 Android App 从一个单通道代理客户端，升级为一个利用 Go 核心全部能力的“微型网关”。

#### **迭代 7.1: 多通道网关模式与 VLESS 集成**
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   **确立了移动端“微型网关”架构**: App 内部运行一个完整的 `AppServer` 实例，与桌面版共享同一套核心逻辑（Dispatcher, 健康检查, 负载均衡）。
    *   **实现从单通道到多通道的飞跃**: App 现在可以将所有激活的服务器配置一次性传递给 Go 核心，由其进行智能负载均衡和故障转移。
    *   **完整集成 VLESS 协议**: 扩展了 Android 的数据模型和 UI，以支持 VLESS 协议的全部配置项。

#### **迭代 7.2: 移动端路由功能完善**
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   **实现了基于目标的路由规则 UI**: 在 Android App 中创建了功能完整的路由规则管理界面。
    *   **打通了配置传递链路**: 实现了将 App 端配置的路由规则在启动 VPN 时完整、正确地传递给 Go 核心的机制。
    *   **提升了 App 健壮性**: 修复了多项因数据格式不兼容、Activity 未注册等导致的闪退和配置丢失问题。

---

### **阶段八：代理池与动态资源管理 (Current)**

本阶段旨在为 `nexus` 网关内建一个动态的、自维护的公共代理池，以解决手动配置大量通道的繁琐问题。

#### 迭代 8.1: 核心引擎 - 抓取与验证
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   成功搭建了 `proxypool` 内部模块，包含所有核心组件。
    *   **成功实现了全部 4 个目标网站的并发抓取**，并解决了 JS 渲染和 WAF 拦截等复杂问题。
    *   **成功修复并验证了 `Validator` 模块**，确认其能准确识别支持 `CONNECT` 的代理，并更新成功/失败计数。
    *   通过一次性运行测试，**成功抓取、验证并找到了 10 个可用代理**，并将包含所有代理状态的完整列表持久化到了 `proxies.json` 文件。

#### **迭代 8.2: 服务化 - 调度器与内部接口**
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   创建了 `proxypool.Manager` 作为模块主入口，并内置了两个独立的定时调度器（抓取新代理、重新验证存量代理）。
    *   **成功实现了动态调度算法**：基于代理的成功/失败历史，采用**分级间隔策略**来智能地安排下一次健康检查的时间，实现了高效的生命周期管理。
    *   `Manager` 提供了优化的内部接口 `GetAvailableProxies()`，该接口按“成功次数”和“延迟”对健康代理进行排序，确保总是返回最优的可用资源。

#### **迭代 8.3: SOCKS5 上游代理支持**
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   **验证器增强**: `Validator` 模块被成功改造，能够智能地根据 `ScrapedProtocol` 字段，分别对 `HTTP` 和 `SOCKS5` 代理执行各自的验证流程，并将结果写入 `VerifiedProtocol` 字段。
    *   **新增 SOCKS5 策略**: 成功创建了 `socks5proxy.Strategy`，专门用于处理与上游 SOCKS5 代理的连接。`tunnel` 工厂函数也被更新，能够根据服务器配置中的 `ProxyProtocol` 字段，动态实例化 `httpproxy.Strategy` 或 `socks5proxy.Strategy`。
    *   **健康检查简化**: 为 `httpproxy` 和 `socks5proxy` 两种策略统一采用了最稳定可靠的 TCP 拨号健康检查。

#### **迭代 8.4: UI 集成 - 监控与手动辅助**
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   **手动配置辅助**: 实现了 `GET /api/proxypool/available` 接口，该接口能够根据协议 (`http` 或 `socks5`) 筛选代理池资源。前端UI相应地增加了“从代理池获取”功能，并实现了“**一个IP只能配置一次**”的严格业务规则，极大简化了配置流程。
    *   **简化版监控页面**: 新增了 "Proxy Pool" 页面，通过 `GET /api/proxypool/all` 接口定期刷新，直观地展示了所有健康代理的实时状态（`Idle` / `In Use`）、协议、延迟、成功次数等关键信息。


#### **迭代 8.5: 手动快速导入代理**
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   在 "Proxy Pool" 页面新增了通过模态对话框手动导入 `IP:Port` 列表的功能。
    *   后端 `Manager` 能够接收、解析并为新代理触发即时后台验证，验证完成后自动保存。
    *   修复了因模块加载顺序问题导致的 JavaScript 错误，确保了前端功能的稳定性。

#### **迭代 8.6: 代理池 UI 增强**
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   为 "Proxy Pool" 页面增加了分页、状态筛选、批量选择、手动触发测试和批量删除功能，将其从一个监控页面升级为管理工具。
    *   移除了页面的自动刷新机制，改为手动刷新和操作后自动刷新，优化了用户体验。
    *   通过精细化的 DOM 更新逻辑，解决了在表格中复制文本时选区被意外取消的问题。

#### **迭代 8.7: 代理源更新**
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   移除了在中国大陆访问不稳定的 `proxyscrape.com` 抓取器。
    *   新增并修复了 `proxy-list.download` 的抓取器，使其能够正确解析目标网站的 HTML 结构。
    *   优化了代理池的初始数据源，使其更聚焦于可靠的中国区代理。

#### **迭代 8.8: 地理位置精化**
*   **状态**: ✅ **已完成**
*   **关键成果**:
    *   重构了 `Validator` 模块，在代理验证成功后，通过调用 `ip-api.com` 的中文接口获取精确的地理位置信息。
    *   实现了标准的地理位置格式化逻辑 (`来源-省-市` 或 `来源-国家`)，并解决了重启后地理位置信息被覆盖的严重 Bug。
    *   将所有 `Scraper` 的职责简化为只抓取原始数据，不再处理地理位置信息，使数据处理流程更加健壮。
---


### **阶段九：DNS 增强与高级路由 (Planned)**

本阶段的总体目标，是将 `liuproxy_nexus` 从一个主要处理 L4 流量的网关，升级为一个能够理解并智能控制 L7 应用层信息（特别是 DNS）的、功能更全面的网络中枢。

---

### **迭代 9.1: 内置 DNS 服务器与劫持**

**目标**: 获得对局域网内所有 DNS 查询的完全控制权，从根源上解决 DNS 污染、投毒和泄漏问题，并通过缓存提升解析速度。

**1. 后端实现：DNS 服务模块 (`dns_server`)**
*   **技术选型**: 将在 `liuproxy_nexus` 内部集成一个轻量级的 DNS 服务器。我们会使用 Go 生态中成熟的 `miekg/dns` 库作为基础。
*   **核心功能**:
    *   监听一个内部 UDP 端口（例如 `127.0.0.1:5353`）。
    *   能够接收标准的 DNS 查询请求。
    *   实现一个带 TTL 的内存缓存，用于存储 DNS 查询结果，减少对上游的请求。
    *   能够将缓存未命中的查询，转发到用户指定的上游 DNS 服务器。

**2. 后端实现：透明劫持 (`TransparentGateway` & `entrypoint.sh`)**
*   **`entrypoint.sh` 脚本**: 将增加新的 `iptables` `DNAT` 规则，专门用于拦截局域网设备发往外部 UDP 53 端口的 DNS 查询流量，并将其重定向到 `TransparentGateway` 的监听端口。
*   **`TransparentGateway` 模块**:
    *   在其 UDP 处理器中，增加逻辑来识别这些被重定向的 DNS 查询包。
    *   它不会将这些 DNS 包交给 `Dispatcher` 进行路由，而是直接转发给内部的 `dns_server` 模块进行处理。

**3. 配置与 UI (`settings.json` & Web UI)**
*   **`settings.json`**: 将新增一个 `dns` 配置块，结构如下：
    ```json
    "dns": {
      "enabled": true,
      "hijack_enabled": true,
      "upstream_servers": [
        "223.5.5.5", 
        "8.8.8.8"
      ]
    }
    ```
*   **Web UI**:
    *   创建一个新的 "DNS" 页面。
    *   提供一个总开关 (`enabled`) 来启用或禁用整个 DNS 功能。
    *   提供一个“透明劫持”开关 (`hijack_enabled`)。
    *   提供一个文本框，允许用户配置多个上游 DNS 服务器。

**预期成果**: 此迭代完成后，只要用户在 UI 上开启 DNS 劫持，`nexus` 就能成为局域网的强制 DNS 服务器，所有设备的 DNS 请求都将通过它处理，安全、干净且高效。

---

### **迭代 9.2: DNS 路由与分流**

**目标**: 基于查询的域名，对 DNS 请求本身进行智能路由，实现更精细化的解析策略和 DNS 级别的广告屏蔽。

**1. 后端实现：`Dispatcher` 与 `dns_server` 联动**
*   **流程变更**: `dns_server` 在收到查询后，不再直接转发，而是先将**查询的域名**交给 `Dispatcher` 进行决策。
*   **`Dispatcher` 扩展**:
    *   增加一个新的决策方法，如 `DispatchDNS(domain string)`。
    *   此方法将匹配一种新的规则类型：`dns_domain`。

**2. 后端实现：DNS 专用规则与目标**
*   **`settings.json`**: `routing.rules` 将支持新规则：
    *   **规则类型**: `dns_domain`。
    *   **特殊目标**: 引入 `UPSTREAM_LOCAL`, `UPSTREAM_REMOTE` 等关键字，对应 `dns` 配置块中不同的上游服务器组。也支持直接返回一个 IP 地址（如 `0.0.0.0`）。
    *   **示例**:
        ```json
        { "type": "dns_domain", "value": ["*.cn", "mi.com"], "target": "UPSTREAM_LOCAL" },
        { "type": "dns_domain", "value": ["google.com"], "target": "UPSTREAM_REMOTE" },
        { "type": "dns_domain", "value": ["ads.example.com"], "target": "0.0.0.0" }
        ```

**3. 后端实现：DNS-over-Proxy**
*   **关键功能**: 当 `Dispatcher` 决策为 `UPSTREAM_REMOTE` 时，`dns_server` 必须能够将这个 DNS 查询本身通过一个指定的代理通道发送出去。
*   **实现方式**: `dns_server` 将不再直接进行 UDP/53 查询，而是优先使用 DNS-over-HTTPS (DoH)。它会构造一个 DoH 请求，并通过一个配置了代理的 `http.Client` 来发送。这个 `http.Client` 的流量会再次经过 `Dispatcher`，从而实现 DNS 请求的隧道化。

**4. Web UI 增强**
*   "DNS" 页面将增加一个规则编辑器，允许用户创建、编辑、删除 `dns_domain` 规则。
*   上游 DNS 服务器配置将分组为 `local` 和 `remote`。

**预期成果**: `nexus` 将具备 DNS 级别的分流能力，可以根据域名将解析任务交给最合适的 DNS 服务器，同时实现高效的广告屏蔽。

---

### **迭代 9.3: 高级路由 - 规则集与逻辑组合**

**目标**: 引入外部规则集（`geosite`, `geoip`）和逻辑操作，极大简化复杂路由策略的配置，使其接近主流代理软件的体验。

**1. 后端实现：规则集管理器 (`ruleset_manager`)**
*   **新模块**: 创建一个 `ruleset_manager` 模块。
*   **功能**:
    *   能根据 `settings.json` 中的 URL 列表，**下载**远程规则集文件。
    *   内置**解析器**，支持 `geosite`（域名列表）和 `geoip`（IP/CIDR 列表）等常见格式。
    *   将解析后的数据加载到内存中，使用高效的数据结构（如 Trie-tree 或 map）进行存储，以备快速查询。
    *   内置**调度器**，定期自动更新这些远程规则集。

**2. 后端实现：`Dispatcher` 规则引擎升级**
*   **规则匹配扩展**: `Dispatcher` 在匹配规则时，除了检查 `value` 字段，还会检查是否存在 `rule_set` 字段。
*   **新规则格式**:
    ```json
    // 按域名规则集匹配
    { "type": "domain", "rule_set": "geosite:cn", "target": "DIRECT" },
    // 按 IP 规则集匹配
    { "type": "dest_ip", "rule_set": "geoip:cn", "target": "DIRECT" }
    ```
*   **逻辑组合 (初步)**: 探索支持 `AND` 逻辑，例如允许一个规则同时包含 `source_ip` 和 `rule_set` 字段，必须两者都满足才匹配。

**3. Web UI 升级**
*   **新页面/板块**: 在 "Routing" 页面下增加 "Rule Sets" 管理板块。
*   **功能**:
    *   允许用户添加远程规则集的 URL，并为其指定一个别名（如 `geosite-cn`）。
    *   显示每个规则集的最后更新时间和条目数量。
    *   在路由规则编辑器中，提供一个下拉菜单，让用户可以直接选择一个已加载的规则集，而不是手动填写 `value`。

**预期成果**: 用户不再需要手动维护成百上千条域名或 IP 规则。只需引入权威的第三方规则集，即可通过几条简单的规则实现“国内网站直连、国外网站走代理、广告屏蔽”等复杂而强大的路由策略。

---

---

### **阶段十：架构演进与生态系统 (Future)**

本阶段将探索下一代网络处理架构，目标是使 `liuproxy_nexus` 在核心能力上达到业界顶尖水平。

#### **迭代 10.1: 探索并集成 TUN 虚拟接口**
*   **状态**: 📝 **计划中**
*   **核心任务**:
    *   `[Research]` 调研并选择合适的用户态网络协议栈库（如 `gVisor`, `sagernet/sing-tun`）。
    *   `[Backend]` 实现一个新的 `TUNGateway` 流量入口，能够从虚拟网卡读取原始 IP 包，并重组为 TCP/UDP 流。
*   **预期成果**: `liuproxy_nexus` 演进为 L3 网关，摆脱对 `iptables` 拦截方式的强依赖，为实现 FakeIP 等高级功能奠定基础。

#### **迭代 10.2: 实现 FakeIP 以增强域名路由**
*   **状态**: 📝 **计划中**
*   **核心任务**:
    *   `[Backend]` 集成 FakeIP 机制，当内置 DNS 服务器收到需代理的域名查询时，返回一个来自私有地址池的“假 IP”。
    *   `[Backend]` 维护 `FakeIP -> 域名` 的映射表。
    *   `[Backend]` `TUNGateway` 在捕获到去往 FakeIP 的数据包时，通过查询映射表反向解析出原始域名，实现对所有流量的精确域名路由。
*   **预期成果**: 解决传统透明代理在处理 gRPC、SSH 等非 TLS 流量时无法基于域名进行分流的痛点。