# LiuProxy v3.0 - Unified Development Roadmap

**最后更新**: 2025-09-28

本文档是 `LiuProxy v3.0` 项目的“活文档”，它既是未来的开发计划，也是对已完成工作的进度跟踪。它详细记录了每个阶段的核心任务、关键决策和重要产出。

---
## **总览**

*   **阶段一: 基础奠定 (已完成)**
*   **阶段二: Go 原生网关实现与架构统一 (已完成)**
*   **阶段三: 产品化与生态系统完善 (已完成)**
*   **阶段四: 全面在线化配置与高级功能 (已完成)**
*   **阶段五: 底层网络与透明代理 (进行中)** - 当前阶段，旨在将项目从应用层代理演进为真正的网络网关。

---
## **详细路线图**

### **阶段一 ~ 阶段三 (Completed)**
*   所有迭代均已完成。
---

### **阶段四：全面在线化配置与高级功能 (Completed)**

#### **迭代 4.1: 统一配置架构与网关参数在线化**
*   **状态**: ✅ **已完成**

#### **迭代 4.2: 路由规则管理 UI 与优先级系统重构**
*   **状态**: ✅ **已完成**

#### **迭代 4.3: 负载均衡策略在线化与UI架构重构**
*   **状态**: ✅ **已完成 (2025-09-28)**
*   **核心任务**:
    *   `[Backend]` ✅ **实现负载均衡策略模式**: 在 `Dispatcher` 中引入 `LoadBalancer` 接口，并实现了 "Least Connections" 和 "Round Robin" 两种策略。
    *   `[System]` ✅ **合并配置**: 将负载均衡策略配置整合进 `settings.json` 的 `gateway` 模块中。
    *   `[Backend]` ✅ **实现负载均衡热重载**: `Dispatcher` 现在可以根据 `gateway` 配置的变更，动态切换负载均衡策略。
    *   `[Web UI]` ✅ **UI架构重构**: 将 "Settings" 页面拆分为独立的 "Gateway" 和 "Routing" 页面，优化了用户体验和可扩展性。
*   **关键决策**: **采纳了将UI页面按功能模块拆分的建议**，并**将负载均衡策略视为网关的核心属性**，使配置逻辑更内聚。

#### **迭代 4.4: 移动端体验增强**
*   **状态**: 📝 **计划中**
*   **核心任务**:
    *   `[Android]` **(APP-05)**: 在 UI 和通知栏显示延迟和实时速度。
    *   `[Android]` **(APP-06)**: 支持通过 URL 订阅添加和更新服务器列表。

---

### **阶段五：底层网络与透明代理 (Current)**

本阶段的核心目标是实现一个功能完备的传统网络网关，支持防火墙和透明代理。

#### **迭代 5.1: 核心架构解耦与健壮性重构**
*   **状态**: ✅ **已完成**
*   **核心任务**:
    *   `[Backend]` ✅ **架构解耦 (IOC)**: 彻底移除了 `Gateway` 和 `Strategy` 之间基于 `localPort` 的硬耦合。`Gateway` 现在通过 `Dispatcher` 获取 `Strategy` 实例的抽象接口。
    *   `[Backend]` ✅ **实现内存管道通信**: `Strategy` 通过 `GetSocksConnection()` 方法，利用 `net.Pipe()` 为 `Gateway` 提供一个高效的、内存中的 SOCKS5 连接，完全消除了内部TCP回环的开销。
    *   `[System]` ✅ **分离配置与生效**: 重构了配置管理流程。UI上的修改现在只更新后端的配置区 (`configState`) 和 JSON 文件，并通过一个新增的“应用变更”按钮来触发实例的重新加载和部署，从根本上解决了因网络I/O导致的界面锁死问题。
    *   `[System]` ✅ **简化故障处理**: 废除了复杂的失败计数器机制，改为在连接失败时由 `Strategy` 直接调用 `StateManager` 接口，将实例状态立即置为 `Down`，并通过 WebSocket 实时推送到前端。
*   **关键决策与成果**:
    *   **确立了最终的内部通信模型**: `Gateway` 保持其作为“协议转换器”的强大功能，`Strategy` 保持其作为“纯粹SOCKS5服务器”的简单性。两者通过内存管道 `net.Pipe` 高效连接，兼顾了性能与职责分离。
    *   **引入“配置暂存区”**: 彻底解决了在持有全局锁的同时执行阻塞I/O的并发问题，显著提升了系统的健壮性和UI响应速度。
    *   **实现了实时状态推送**: 通过引入 WebSocket，前端能够近乎实时地响应后端的健康状态变化，提升了用户体验。

#### **迭代 5.2: 透明网关与防火墙实现**
*   **状态**: ✅ **已完成**
*   **核心任务**:
    *   `[Backend]` ✅ **实现 `TransparentGateway`**: 创建了新的流量入口模块，使用 `getsockopt(SO_ORIGINAL_DST)` 获取被 `iptables` 重定向流量的原始目标地址。
    *   `[System]` ✅ **实现防火墙引擎**: 设计并构建了 `FirewallEngine`，支持基于优先级、CIDR、端口和协议的规则匹配，并作为透明流量处理的第一道关卡。
    *   `[Backend]` ✅ **适配策略接口**: 在 `TunnelStrategy` 接口上新增了 `HandleRawTCP` 方法，并为 `goremote`, `vless`, `worker` 策略实现了该方法，使其能直接处理原始TCP连接。
    *   `[Web UI]` ✅ **创建防火墙管理界面**: 在UI中新增了独立的 "Firewall" 页面，提供了完整的规则CRUD（增删改查）功能和模块启用/禁用开关。
    *   `[System]` ✅ **集成热重载**: `SettingsManager` 现在可以管理 `"firewall"` 模块的配置，允许规则和防火墙状态被实时更新而无需重启服务。
*   **关键决策与成果**:
    *   **确立了双入口网关模型**: 系统现在拥有两个并行的流量入口（`Gateway` 用于转发代理，`TransparentGateway` 用于透明代理），它们共享同一个决策核心（`Dispatcher`），在扩展功能的同时未影响原有功能的稳定性。
    *   **实现了“防火墙优先”的处理流程**: 确立了关键的安全模型，即所有透明流量必须先通过防火墙的审查，才能进入后续的路由分流逻辑。
    *   **提升了UI交互健壮性**: 根据用户反馈，将规则（路由和防火墙）的保存操作改为在对话框确认时立即自动持久化到后端，防止了因忘记点击“保存模块设置”而导致的数据丢失。

#### **迭代 5.3: 流量监控、容器化与文档**
*   **状态**: ✅ **已完成**
*   **核心任务**:
    *   `[Backend]` ✅  **实现流量监控API**: 提供一个WebSocket端点，用于实时推送连接日志。
    *   `[Web UI]` ✅  **创建 "Monitor" 页面**: 用于实时展示网络活动。
    *   `[DevOps]` ✅  **创建 `Dockerfile` 与启动脚本**: 将应用打包为支持 `NET_ADMIN` 的Docker镜像，并编写 `iptables` 初始化脚本。
    *   `[Docs]` ✅  **撰写网关模式部署文档**，详细说明在Linux Docker环境下的部署和使用方法，并明确指出在Windows下的局限性。
    *   **关键决策与成果**:
        *   **成功将 `LiuProxy` 产品化为一体化网络网关**: 通过本次迭代，项目从一个应用层的转发代理，正式演进为一个功能完备、易于部署、可监控的透明网络网关解决方案。
        *   **解决了复杂的部署环境问题**: 通过系统性的故障排查，我们定位并解决了 `snap` 版 Docker 的沙盒限制、`CRLF` 换行符、内核参数（混杂模式、`sysctl`）等一系列底层环境问题，为后续的稳定部署奠定了坚实基础。
        *   **修复了核心策略的并发与性能瓶颈**: 解决了 `goremote` 和 `worker` 策略在处理高并发、大流量透明代理连接时因协议时序和缓冲区设计不当导致的死锁和性能问题。

### **阶段六：高级功能与体验优化 (Current)**

本阶段将为网关添加更多高级网络功能，并优化用户交互体验。

#### **迭代 6.1: UDP 透明代理支持**
*   **状态**: ✅ **已完成 (日期)**
*   **核心任务**:
    *   `[DevOps]` ✅ **更新 `entrypoint.sh` 脚本**: 最终采用 `iptables` `DNAT` 规则代替 `TPROXY`，在不干扰容器出站流量的前提下，安全地拦截了 UDP 流量。
    *   `[Backend]` ✅ **扩展 `TransparentGateway`**: 成功添加了 UDP 监听器，并实现了一个无状态的、基于路由规则的 UDP 包处理器。
    *   `[System]` ✅ **扩展 `TunnelStrategy` 接口**: 增加了 `HandleUDPPacket` 方法，为 UDP 转发提供了统一的策略接口。
    *   `[Backend]` ✅ **为 `goremote` 策略实现 UDP 转发**: 成功将截获的 UDP 包封装成 SOCKS5 UDP 格式，并通过 `goremote` 隧道进行转发。
    *   `[Backend]` ✅ **为 `vless` 和 `worker` 策略提供明确的不支持处理**: 添加了相应的日志记录和丢弃逻辑。
*   **关键决策与成果**:
    *   **成功扩展网关核心能力**: `LiuProxy` 现在是一个同时支持 TCP 和 UDP 的双栈透明网关，应用场景得到了极大扩展（例如支持 DNS 查询）。
    *   **解决了底层网络路由冲突**: 在实践中发现并解决了标准 `TPROXY` 配置与 Docker `macvlan` 环境下的出站流量冲突问题，最终采用更稳定、副作用更小的 `DNAT` 方案，增强了部署的健壮性。

#### **迭代 6.2: 仪表盘与统计**
*   **状态**: ✅ **已完成 (日期)**
*   **核心任务**:
    *   `[Backend]` ✅ **实现统计数据聚合**: 在 `AppServer` 中创建了一个 statsLoop，用于定期轮询并累加所有活动实例的指标。
    *   `[Web UI]` ✅ **创建 "Dashboard" 页面**: 新增了 "Dashboard" 作为默认首页，包含统计卡片和图表占位符。
    *   `[System]` ✅ **建立实时推送通道**: 扩展了 WebSocket (`Hub`)，增加了 `dashboard_update` 消息类型，用于将后端聚合的统计数据实时推送到前端。
    *   `[Web UI]` ✅ **实现前端数据可视化**: 引入了 `Chart.js`，并实现了接收 WebSocket 数据、更新统计卡片和动态绘制图表的逻辑。
*   **关键决策与成果**:
    *   **建立了完整的可观测性数据链路**: 成功打通了从后端策略实例 -> `AppServer` 聚合 -> WebSocket 推送 -> 前端图表渲染的完整数据流，为未来扩展更多监控指标奠定了基础。
    *   **初步实现了核心指标监控**: 仪表盘现在可以准确、实时地展示**总活动连接数**。
    *   **技术决策**: 在实现实时速率统计时，遇到了 `io.Copy` 优化绕过 `net.Conn` 包装器的问题。

#### **迭代 6.3: GoRemote 通道彻底重构与多路复用**
*   **状态**: ✅ **已完成**
*   **核心任务**:
    *   `[System]` ✅ **回归本源 - 纯 TCP 传输**: 彻底废弃了 `goremote` v2.2 中基于 WebSocket 的复杂实现，回归到性能最高、开销最低的纯 TCP 连接模型。
    *   `[Backend]` ✅ **实现无状态短连接 (多连接模式)**: `gateway` 和 `remote` 两端均采用“一次性连接”模式处理 TCP 流量，从根本上消除了长连接模式下的所有并发、超时和状态污染问题。
    *   `[Protocol]` ✅ **协议极简与安全增强**: 设计并实现了 `goremote v3.1` 协议。通过在每个连接的头部发送一个加密的元数据包，既保证了目标地址不被泄露，又保持了协议的极简高效。
    *   `[Backend]` ✅ **实现原生 UDP 隧道**: 首次为 `goremote` 增加了完整的 UDP 支持（包括转发代理和透明代理）。通过在 `gateway` 和 `remote` 之间建立原生的 UDP 通道并封装 SOCKS5 UDP 格式，实现了低延迟、高性能的 UDP 转发。
    *   `[Backend]` ✅ **实现 TCP 多路复用 (Mux 模式)**: 基于 `smux` 库，为 `goremote` 的 TCP 流量增加了多路复用功能，显著降低了高并发短连接场景下的延迟。
    *   `[Protocol]` ✅ **实现隐式协议协商**: `remote` 端能通过 TCP 连接的第一个数据包特征，自动、可靠地区分“多连接”模式和“多路复用”模式的请求，实现了对两种模式的无缝兼容。
    *   `[Web UI]` ✅ **UI 集成**: 在 Web UI 中增加了 `Multiplex` 开关，允许用户为每个 `goremote` 服务器方便地启用或禁用多路复用。
*   **关键决策与成果**:
    *   **`goremote` 的重生**: 本次重构使 `goremote` 从一个复杂、不稳定的通道，脱胎换骨成为我们工具箱中**最快、最灵活、功能最全面**（唯一原生支持 UDP 和 TCP 多路复用）的王牌通道。
    *   **架构清晰化**: 确立了 `goremote` 作为“性能担当”的清晰定位，而 `vless-ws` 和 `worker` 则负责“伪装与穿透”，使得整个代理体系功能互补，架构更加合理。
    *   **问题根除**: 通过本次重构，一劳}+\-逸地解决了困扰项目许久的 `goremote` 通道稳定性问题。
    *   **修复核心网关缺陷**: 修复了 `Dispatcher` 的 `DIRECT` 路由模式在处理 SOCKS5 和 HTTP 代理协议时的缺陷，确保了路由功能的完整性。


### **阶段七：移动端架构升级与 VLESS 支持 (Current)**

本阶段的核心目标是将 Android App 从一个单通道代理客户端，升级为一个利用 Go 核心全部能力的“微型网关”，以实现多通道负载均衡，并扩展对 VLESS 协议的支持。

#### **迭代 7.1: 多通道网关模式与 VLESS 集成**
*   **状态**: 🔄 **进行中**
*   **核心任务**:
    *   `[Go Backend]` **重构 `mobile` API**: Go 核心将以内嵌一个“无头”`AppServer` 的形式启动，提供一个统一的动态端口，用于处理所有代理请求。
    *   `[Android]` **扩展数据模型**: `ProfileItem.kt` 将被扩展，以完整支持 VLESS、GoRemote 和 Worker 协议的所有配置项。
    *   `[Android]` **重构配置 UI**: 使用 Jetpack Compose 重写服务器配置界面，实现基于协议类型的动态表单，大幅改善 VLESS 等复杂协议的配置体验。
    *   `[Android]` **调整 VPN 启动流程**: App 启动时，会将所有用户选择激活的服务器配置一次性传递给 Go 核心，由其内部的 `Dispatcher` 进行统一的负载均衡和故障转移。
*   **关键决策与成果**:
    *   **确立了移动端“微型网关”架构**: 通过在 App 内部运行一个完整的 `AppServer` 实例，移动端将与桌面版共享同一套经过验证的核心逻辑（Dispatcher, 健康检查, 负载均衡），极大地提升了性能、稳定性与代码一致性。
    *   **实现从单通道到多通道的飞跃**: 用户将能够同时利用多个激活的服务器进行连接，通过后端的智能负载均衡，预期将显著提升连接速度和稳定性。
    *   **将 VLESS 协议完整集成到 Android App 生态中**，扩展了 App 的适用范围和灵活性。

**迭代 7.2: 移动端路由功能完善**
*   **状态**: ✅ **已完成**
*   **核心任务**:
    *   `[Android]` ✅ **实现基于目标的路由规则 UI**: 使用 Jetpack Compose 创建了功能完整的路由规则管理界面 (`RoutingRuleActivity`)。
    *   `[Go Backend]` ✅ **实现历史目标记录与API**: Go 核心现在能记录最近访问的目标地址，并通过 `gomobile` API (`GetRecentTargets`) 和 Web API (`/api/recent_targets`) 暴露给客户端。
    *   `[Android]` ✅ **打通配置传递链路**: 实现了将 App 端配置的路由规则 (`RoutingRule`) 在启动 VPN 时完整、正确地传递给 Go 核心的机制。
    *   `[Android]` ✅ **实现客户端智能过滤**: 优化了用户体验，在 App 端实现了对历史目标地址的双重过滤，能即时排除所有已配置（包括暂存）的规则。
    *   `[Android]` ✅ **修复多项关键 Bug**:
        *   解决了因 `Activity` 未在 `AndroidManifest.xml` 注册导致的 `ActivityNotFoundException`。
        *   恢复了被覆盖的“分应用代理”入口，理清了两种路由功能的 UI 路径。
        *   通过将 `id` 持久化并增加空值保护，彻底解决了因旧数据格式不兼容导致的 `NullPointerException` 闪退问题。
*   **关键决策与成果**:
    *   **确立了移动端与 Go 核心之间清晰、解耦的配置传递模式**，特别是将服务器配置和路由规则作为独立参数传递，增强了系统的可维护性。
    *   **通过一系列的故障排查和修复，显著提升了 Android App 的健壮性和稳定性**，为未来添加更多功能奠定了坚实的基础。


### **阶段八：DNS 增强与高级路由 (Current)**

本阶段的核心目标是将 `LiuProxy` 从一个基于 IP/域名的流量转发器，升级为一个能够深度理解并控制 DNS 查询的智能网关。

#### **迭代 8.1: 内置 DNS 服务器与劫持**
*   **状态**: 📝 **待开发**
*   **核心任务**:
    *   `[Backend]` **实现内置 DNS 服务器**: 在 `AppServer` 中集成一个轻量级的 DNS 服务器，能够接收标准的 DNS 查询请求。
    *   `[Backend]` **实现 DNS 劫持**: `TransparentGateway` 将能够识别流向外部 DNS 服务器的 UDP/53 流量，并将其强制重定向到内置 DNS 服务器。
    *   `[Web UI]` **创建 "DNS" 管理页面**: 在 Web UI 中新增 "DNS" 页面，允许用户配置上游 DNS 服务器（如 `223.5.5.5` for local, `8.8.8.8` for remote）。
    *   `[Web UI]` **提供劫持开关**: 在 UI 上提供一个简单的开关来启用/禁用全局 DNS 劫持。
*   **预期成果**: 从根本上解决 DNS 污染和泄漏问题，所有经过网关的设备的 DNS 查询都将由 `LiuProxy` 统一管理。

#### **迭代 8.2: DNS 路由与分流**
*   **状态**: 📝 **待开发**
*   **核心任务**:
    *   `[Backend]` **扩展 `Dispatcher`**: 使 `Dispatcher` 能够解析 DNS 查询报文，并根据查询的**域名**来匹配新的 DNS 路由规则。
    *   `[Backend]` **实现 DNS 专用出口**: 允许 DNS 查询本身通过指定的代理通道（如 DoH, DoT）发出，以保护 DNS 查询的隐私。
    *   `[Web UI]` **增强 "DNS" 页面**: UI 将支持创建 DNS 规则，例如：
        *   查询 `*.cn` 的域名 -> 使用 `local` DNS 服务器。
        *   查询 `*.google.com` 的域名 -> 使用 `remote` DNS 服务器。
        *   查询 `ads.example.com` -> 直接返回 `0.0.0.0` (去广告)。
*   **预期成果**: 实现精细化的 DNS 查询分流，提升解析速度和准确性。

#### **迭代 8.3: 高级路由 - 规则集与逻辑组合**
*   **状态**: 📝 **待开发**
*   **核心任务**:
    *   `[Backend]` **实现规则集管理器**: `AppServer` 将能够从远程 URL 下载并解析 `geosite` 和 `geoip` 等规则集文件。
    *   `[Backend]` **扩展 `Dispatcher` 规则引擎**: 引入对 `rule_set` 关键字和 `AND`, `OR`, `NOT` 逻辑组合的支持。
    *   `[Web UI]` **升级 "Routing" 页面**: UI 将允许用户添加远程规则集，并在创建规则时引用它们，或创建复杂的逻辑规则。
*   **预期成果**: 用户可以轻松实现“国内直连、国外代理”等主流代理场景，无需手动维护大量的域名/IP列表，大幅提升易用性。

---

### **阶段九：架构演进与生态系统 (Future)**

本阶段将探索下一代网络处理架构，目标是使 `LiuProxy` 在核心能力上达到业界顶尖水平。

#### **迭代 9.1: 探索并集成 TUN 虚拟接口**
*   **状态**: 📝 **待开发**
*   **核心任务**:
    *   `[Research]` **技术选型**: 调研并选择合适的用户态网络协议栈库（如 `gVisor`, `sagernet/sing-tun`）。
    *   `[Backend]` **实现 TUN 入口**: 创建一个新的 `TUNGateway` 流量入口，能够从虚拟网卡读取原始 IP 包。
    *   `[Backend]` **集成协议栈**: 使用所选库将 L3 的 IP 包重新组合为 L4 的 TCP/UDP 流。
    *   `[System]` **适配路由**: 修改 `entrypoint.sh` 或通过 Go 程序，使用 `ip route`/`ip rule` 将系统流量路由到 TUN 设备。
*   **预期成果**: `LiuProxy` 演进为 L3 网关，摆脱对 `iptables` 拦截方式的强依赖，为实现 FakeIP 等高级功能奠定基础。

#### **迭代 9.2: 实现 FakeIP 以增强域名路由**
*   **状态**: 📝 **待开发**
*   **核心任务**:
    *   `[Backend]` **集成 FakeIP**: 当内置 DNS 服务器收到一个需要代理的域名查询时，不再返回真实 IP，而是返回一个来自预设私有地址池（如 `198.18.0.0/15`）的“假IP”。
    *   `[Backend]` **维护映射表**: `AppServer` 内部维护一个 `FakeIP -> 域名` 的映射表。
    *   `[Backend]` **反向解析**: 当 `TUNGateway` 捕获到一个目标地址是 FakeIP 的数据包时，通过查询映射表找到其原始域名，从而实现对所有流量（包括无 SNI 的流量）的精确域名路由。
*   **预期成果**: 大幅提升路由的准确性，解决了传统透明代理在处理 gRPC、SSH 等非 TLS 流量时无法基于域名进行分流的痛点。